---
title: "UCEC Multi-Omic Analysis-Selina (Draft1)"
output: html_notebook
---

```{r setup}
output_dir <- "/home1/selinali/490_cluster/analysis_data/outputs"
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}
knitr::opts_knit$set(root.dir = output_dir)
```

```{r}
#packages
if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install(version = "3.21")

if (!require("TCGAbiolinks", quietly = TRUE))
  BiocManager::install("TCGAbiolinks")
if (!require("maftools", quietly = TRUE))
  BiocManager::install("maftools")
if (!require("DESeq2", quietly = TRUE))
  BiocManager::install("DESeq2")
if (!require("survival", quietly = TRUE))
  install.packages("survival")
if (!require("survminer", quietly = TRUE))
  install.packages("survminer")
if (!require("ggplot2", quietly = TRUE))
  install.packages("ggplot2")
if (!require("EnhancedVolcano", quietly = TRUE))
  BiocManager::install("EnhancedVolcano")
if (!require("limma", quietly = TRUE))
  BiocManager::install("limma")
if (!require("sesame", quietly = TRUE))
  BiocManager::install("sesame")
if (!require("data.table", quietly = TRUE))
  install.packages("data.table")

library(TCGAbiolinks)
library(maftools)
library(DESeq2)
library(survival)
library(survminer)
library(ggplot2)
library(EnhancedVolcano)
library(limma)
library(sesame)
library(data.table)
```

#1. Clinical Data Analysis
```{r}
#Query and download clinical data for UCEC
clin_query <- GDCquery(project = "TCGA-UCEC",
                       data.category = "Clinical",
                       data.type = "Clinical Supplement", 
                       data.format = 'BCR Biotab')

#GDCdownload(clin_query)
clinical_data <- GDCprepare(clin_query)
clinic <- clinical_data$clinical_patient_ucec[-c(1,2),]

colnames(clinic)[colnames(clinic) == "bcr_patient_barcode"] <- "Tumor_Sample_Barcode"

#clean survival data
clinic$survival_time <- ifelse(clinic$last_contact_days_to == "[Not Available]" | 
                               is.na(clinic$last_contact_days_to),
                               clinic$death_days_to,
                               clinic$last_contact_days_to)

clinic$survival_time <- as.numeric(clinic$survival_time)
clinic$death_event <- ifelse(clinic$vital_status == "Dead", TRUE, FALSE)

clinic_clean <- clinic[!is.na(clinic$survival_time) & !is.na(clinic$death_event), ]
clinic_clean <- clinic_clean[clinic_clean$neoplasm_histologic_grade %in% c("G1", "G2", "G3"), ]

print(paste("Final clinical dataset:", nrow(clinic_clean), "patients"))
```
```{r}
# Survival analysis by tumor grade
survival_object <- Surv(time = clinic_clean$survival_time, 
                       event = clinic_clean$death_event)

fit_grade <- survfit(survival_object ~ neoplasm_histologic_grade, 
                    data = clinic_clean)

grade_surv_plot <- ggsurvplot(fit_grade,
                             pval = TRUE,
                             risk.table = TRUE,
                             conf.int = FALSE,
                             ggtheme = theme_bw(),
                             title = "UCEC Survival by Tumor Grade",
                             xlab = "Time (days)",
                             ylab = "Survival Probability")

print(grade_surv_plot)
ggsave("clinical_survival_by_grade.png", plot = grade_surv_plot$plot)

# Tumor grade distribution
grade_counts <- table(clinic_clean$neoplasm_histologic_grade)
grade_df <- data.frame(Grade = names(grade_counts), 
                      Count = as.numeric(grade_counts))

grade_dist_plot <- ggplot(grade_df, aes(x = Grade, y = Count, fill = Grade)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = Count), vjust = -0.5) +
  labs(title = "Tumor Grade Distribution in UCEC",
       x = "Tumor Grade", y = "Number of Patients") +
  theme_minimal() +
  theme(legend.position = "none")

print(grade_dist_plot)
ggsave("clinical_grade_distribution.png", plot = grade_dist_plot)
```

#2 MAF
```{r}
#Query and download mafmutation data
maf_query <- GDCquery(project = "TCGA-UCEC",
                      data.category = "Simple Nucleotide Variation",
                      data.type = "Masked Somatic Mutation", 
                      workflow.type = "Aliquot Ensemble Somatic Variant Merging and Masking",
                      access = "open")

#GDCdownload(maf_query)
maf_data <- GDCprepare(maf_query)

# Prepare clinical data for MAF
clinic_maf <- clinic_clean
maf_object <- read.maf(maf = maf_data, clinicalData = clinic_maf, verbose = TRUE)

print(maf_object)
```


```{r}
# Check MAF object structure
barcode_cols <- colnames(maf_object@data)[grepl("barcode|sample|tumor", 
                                                colnames(maf_object@data), 
                                                ignore.case = TRUE)]

# Check if Tumor_Sample_Barcode existsor not
if ("Tumor_Sample_Barcode" %in% colnames(maf_object@data)) {

  maf_sample_ids <- unique(maf_object@data$Tumor_Sample_Barcode)
  
  # Extract patient IDs 
  maf_patient_ids_short <- substr(maf_sample_ids, 1, 12)
  
  clinical_patient_ids <- substr(clinic_clean$Tumor_Sample_Barcode, 1, 12)
  patient_to_grade <- setNames(clinic_clean$neoplasm_histologic_grade, 
                               clinical_patient_ids)
  
  # grade mapping
  maf_patient_grade <- patient_to_grade[maf_patient_ids_short]
  

  new_clinical <- data.frame(
    Tumor_Sample_Barcode = maf_sample_ids,
    Tumor_Grade = maf_patient_grade,
    stringsAsFactors = FALSE
  )
  
  maf_object <- read.maf(maf = maf_data, 
                         clinicalData = new_clinical, 
                         verbose = FALSE)
}
```

```{r}

if (!dir.exists("grade_specific")) {
  dir.create("grade_specific")
}


grades <- c("G1", "G2", "G3")

for (grade in grades) {
  # Get samples for this grade
  grade_samples <- maf_object@clinical.data$Tumor_Sample_Barcode[
    maf_object@clinical.data$Tumor_Grade == grade & 
      !is.na(maf_object@clinical.data$Tumor_Grade)
  ]
  
  if (length(grade_samples) > 0) {

    maf_grade <- subsetMaf(maf = maf_object, tsb = grade_samples)
    
    # Create oncoplot
    png(paste0("grade_specific/grade_", grade, "_oncoplot.png"), 
        width = 12, height = 8, units = "in", res = 300)
    
    unique_genes <- length(unique(maf_grade@data$Hugo_Symbol))
    top_n <- min(20, unique_genes)
    
    oncoplot(maf = maf_grade, top = top_n, fontSize = 0.8)
    
    title(main = paste("UCEC Mutations - Grade", grade, 
                       " (n =", length(grade_samples), ")"), 
          cex.main = 1.2)
    
    dev.off()
  }
}

# Create G3 lollipop plots for TP53 and CCND2
g3_samples <- maf_object@clinical.data$Tumor_Sample_Barcode[
  maf_object@clinical.data$Tumor_Grade == "G3" & 
    !is.na(maf_object@clinical.data$Tumor_Grade)
]

if (length(g3_samples) > 0) {
  maf_g3 <- subsetMaf(maf = maf_object, tsb = g3_samples)
  
  # TP53 lollipop
  tp53_hotspots <- c(175, 213, 220, 248, 282)
  
  png("grade_specific/G3_TP53_lollipop_hotspots.png",
      width = 10, height = 6, units = "in", res = 400)
  
  lollipopPlot(
    maf = maf_g3,
    gene = "TP53",
    AACol = "HGVSp_Short",
    showMutationRate = TRUE,
    labelPos = tp53_hotspots,
    repel = TRUE,
    labPosSize = 0.7,
    labPosAngle = 45,
    pointSize = 1.3
  )
  
  title(main = "TP53 Hotspot Mutations in UCEC Grade 3 Tumors",
        cex.main = 1.2)
  
  dev.off()
  
  # CCND2 lollipop plot
  png("grade_specific/G3_CCND2_lollipop.png",
      width = 8, height = 4.5, units = "in", res = 400)
  
  lollipopPlot(
    maf = maf_g3,
    gene = "CCND2",
    AACol = "HGVSp_Short",
    showMutationRate = TRUE,
    labelPos = "all",
    repel = TRUE,
    labPosSize = 0.7,
    labPosAngle = 45,
    pointSize = 1.3
  )
  
  title(main = "CCND2 Mutations in UCEC Grade 3 Tumors", 
        cex.main = 1.2)
  
  dev.off()
}

```



#3. TRANSCRIPTOMIC DATA (RNA-seq)
```{r}
#Query and download RNA-seq data
rna_query <- GDCquery(project = "TCGA-UCEC",
                      data.category = "Transcriptome Profiling",
                      data.type = "Gene Expression Quantification", 
                      workflow.type = "STAR - Counts")

#GDCdownload(rna_query)

```

```{r}
# Prepare SummarizedExperiment
rna_se <- GDCprepare(rna_query)

rna_counts   <- assay(rna_se, "unstranded")
rna_clinical <- as.data.frame(colData(rna_se))

fix_patient12 <- function(x) {
  x2 <- gsub("\\.", "-", x)
  substr(x2, 1, 12)
}

# Patient IDs from RNA columns
rna_patient <- fix_patient12(colnames(rna_counts))

# Patient IDs from clinical table
clinic_clean$patient_short <- fix_patient12(clinic_clean$Tumor_Sample_Barcode)

#Keep non-missing grade
clinic_grade       <- clinic_clean[!is.na(clinic_clean$neoplasm_histologic_grade), ]
clinic_grade_short <- clinic_grade$patient_short

common_patients <- intersect(rna_patient, clinic_grade_short)
```


```{r}

rna_indices <- which(rna_patient %in% common_patients)

# Subset the RNA counts
rna_counts_common <- rna_counts[, rna_indices]
rna_clinical_common <- rna_clinical[rna_indices, ]


patient_to_grade <- setNames(clinic_grade$neoplasm_histologic_grade, 
                            clinic_grade$patient_short)

#Add tumor grade to RNA clinical data
rna_clinical_common$tumor_grade <- patient_to_grade[rna_patient[rna_indices]]
```
```{r}
# Prepare for DESeq2
count_matrix <- as.matrix(rna_counts_common)
mode(count_matrix) <- "numeric"


count_matrix[is.na(count_matrix)] <- 0
keep_genes <- rowSums(count_matrix) >= 10
count_matrix_filtered <- count_matrix[keep_genes, ]

rna_clinical_common$tumor_grade <- factor(rna_clinical_common$tumor_grade, 
                                         levels = c("G1", "G2", "G3"))

#  DESeq
dds <- DESeqDataSetFromMatrix(
  countData = count_matrix_filtered,
  colData = rna_clinical_common,
  design = ~ tumor_grade
)

print(dds)

```

```{r}
# DESeq2
#This part may show error or warning like: Error: attempt to use zero-length variable name (sometimes it does, and sometimes it doesn't)
#but actually the next chunk do run for me
dds <- DESeq(dds)
```

```{r}
#different comparisons
# G3 vs G1
results_g3_vs_g1 <- results(dds, contrast = c("tumor_grade", "G3", "G1"))
results_g3_vs_g1_df <- as.data.frame(results_g3_vs_g1)

# G2 vs G1  
results_g2_vs_g1 <- results(dds, contrast = c("tumor_grade", "G2", "G1"))
results_g2_vs_g1_df <- as.data.frame(results_g2_vs_g1)

print(paste("G3 vs G1 - significant genes (padj < 0.05):", 
            sum(results_g3_vs_g1_df$padj < 0.05, na.rm = TRUE)))
print(paste("G2 vs G1 - significant genes (padj < 0.05):", 
            sum(results_g2_vs_g1_df$padj < 0.05, na.rm = TRUE)))
```

```{r}
# Get results for different comparisons
# G3 vs G1
results_g3_vs_g1 <- results(dds, contrast = c("tumor_grade", "G3", "G1"))
results_g3_vs_g1_df <- as.data.frame(results_g3_vs_g1)

# G2 vs G1  
results_g2_vs_g1 <- results(dds, contrast = c("tumor_grade", "G2", "G1"))
results_g2_vs_g1_df <- as.data.frame(results_g2_vs_g1)

print(paste("G3 vs G1 - significant genes (padj < 0.05):", 
            sum(results_g3_vs_g1_df$padj < 0.05, na.rm = TRUE)))
print(paste("G2 vs G1 - significant genes (padj < 0.05):", 
            sum(results_g2_vs_g1_df$padj < 0.05, na.rm = TRUE)))
```

```{r}

rna_genes <- as.data.frame(rowData(rna_se))

results_g3_vs_g1_df$gene_name <- rna_genes$gene_name[match(rownames(results_g3_vs_g1_df), rna_genes$gene_id)]
results_g2_vs_g1_df$gene_name <- rna_genes$gene_name[match(rownames(results_g2_vs_g1_df), rna_genes$gene_id)]

#volcano plots
volcano_g3_vs_g1 <- EnhancedVolcano(results_g3_vs_g1_df,
                lab = results_g3_vs_g1_df$gene_name,
                x = 'log2FoldChange',
                y = 'pvalue',
                title = 'Differential Expression: G3 vs G1 Tumors',
                subtitle = 'UCEC Transcriptomic Analysis',
                pCutoff = 0.05,
                FCcutoff = 1.0,
                pointSize = 2.0,
                labSize = 4.0)

volcano_g2_vs_g1 <- EnhancedVolcano(results_g2_vs_g1_df,
                lab = results_g2_vs_g1_df$gene_name,
                x = 'log2FoldChange',
                y = 'pvalue',
                title = 'Differential Expression: G2 vs G1 Tumors',
                subtitle = 'UCEC Transcriptomic Analysis',
                pCutoff = 0.05,
                FCcutoff = 1.0,
                pointSize = 2.0,
                labSize = 4.0)

print(volcano_g3_vs_g1)
ggsave("transcriptomic_volcano_G3_vs_G1.png", plot = volcano_g3_vs_g1, width = 10, height = 8)

print(volcano_g2_vs_g1)
ggsave("transcriptomic_volcano_G2_vs_G1.png", plot = volcano_g2_vs_g1, width = 10, height = 8)
```

#4. Metyhlation

```{r}
# Query and download methylation data
methyl_query <- GDCquery(
  project= "TCGA-UCEC",
  data.category = "DNA Methylation",
  data.type = "Methylation Beta Value",
  platform = "Illumina Human Methylation 450"
)


#GDCdownload(methyl_query)
```

```{r}
methyl_se <- GDCprepare(methyl_query)

# Extract beta values and clinical data
methyl_betas <- assay(methyl_se)
methyl_clinical <- as.data.frame(colData(methyl_se))
cpg_sites = as.data.frame(methyl_se@rowRanges@elementMetadata)

print(paste("Methylation data dimensions:", dim(methyl_betas)[1], "probes x", dim(methyl_betas)[2], "samples"))

write.csv(methyl_betas, "ucec_methylation_betas.csv")

```

```{r}
methyl_clinical <- as.data.frame(colData(methyl_se))
methyl_clinical <- methyl_clinical[, !sapply(methyl_clinical, is.list)]

# Extract CpG annotation
cpg_sites <- as.data.frame(methyl_se@rowRanges@elementMetadata)
write.csv(cpg_sites, "ucec_cpg_sites.csv")
```


```{r}

fix_patient12 <- function(x) {
  x2 <- gsub("\\.", "-", x)
  substr(x2, 1, 12)
}

methyl_patient <- fix_patient12(colnames(methyl_betas))

clinic_clean$patient_short <- fix_patient12(clinic_clean$Tumor_Sample_Barcode)
clinic_grade <- clinic_clean[!is.na(clinic_clean$neoplasm_histologic_grade), ]
patient_to_grade <- setNames(clinic_grade$neoplasm_histologic_grade,
                             clinic_grade$patient_short)

# Add tumor grade to methylation clinical data
methyl_clinical$tumor_grade <- patient_to_grade[methyl_patient]

# samples withG1/G2/G3 grade
keep_grade <- methyl_clinical$tumor_grade %in% c("G1", "G2", "G3") & !is.na(methyl_clinical$tumor_grade)
methyl_clinical <- methyl_clinical[keep_grade, ]
methyl_betas <- methyl_betas[, keep_grade]

table(methyl_clinical$tumor_grade)

```


```{r}
#ow vs high grade: G1 vs G3
grade_mask <- methyl_clinical$tumor_grade %in% c("G1", "G3")
methyl_clinical_g13 <- methyl_clinical[grade_mask, ]
betas_g13 <- methyl_betas[, grade_mask]

methyl_clinical_g13$grade_binary <- ifelse(methyl_clinical_g13$tumor_grade == "G3",
                                           "High", "Low")
methyl_clinical_g13$grade_binary <- factor(methyl_clinical_g13$grade_binary,
                                           levels = c("Low", "High"))

betas_g13_clipped <- pmin(pmax(betas_g13, 1e-6), 1 - 1e-6)
mval_g13 <- t(apply(betas_g13_clipped, 1, function(x) log2(x / (1 - x))))

# matrix
design <- model.matrix(~ grade_binary, data = methyl_clinical_g13)
fit <- lmFit(mval_g13, design)
fit2 <- eBayes(fit)

coef_col <- colnames(fit$coefficients)[2]


gene_col <- if ("gene_name" %in% colnames(cpg_sites)) {
  "gene_name"
} else if ("Gene_Symbol" %in% colnames(cpg_sites)) {
  "Gene_Symbol"
} else if ("gene" %in% colnames(cpg_sites)) {
  "gene"
} else if ("UCSC_RefGene_Name" %in% colnames(cpg_sites)) {
  "UCSC_RefGene_Name"
} else {
  colnames(cpg_sites)[1]
}

# volcano
dm_dat <- data.frame(
  foldchange = fit$coefficients[, coef_col],
  logPvalue  = -log10(p.adjust(fit2$p.value[, coef_col], method = "BY")),
  geneName   = cpg_sites[[gene_col]]
)

dm_dat$signif <- with(dm_dat, abs(foldchange) > 1 & logPvalue > 2)

cols <- c("TRUE"="blue", "FALSE"="grey")
```
```{r}
methyl_volcano <- ggplot(dm_dat, aes(x = foldchange, y = logPvalue, color =signif)) +
  geom_point(alpha = 0.3, size = 0.6) +
  scale_colour_manual(values = cols) +
  geom_vline(xintercept = 1,colour = "red", linetype = "dashed") +
  geom_vline(xintercept = -1,colour = "red", linetype = "dashed") +
  geom_hline(yintercept = 2,colour = "red", linetype = "dashed") +
  theme_bw() +
  theme(legend.position = "none") +
  xlab("M-value fold change (High vs Low grade)") +
  ylab("-log10 adjusted p-value") +
  ggtitle("Differential DNA Methylation: G3 vs G1 UCEC Tumors")

print(methyl_volcano)
ggsave("methylation_volcano_G3_vs_G1.png",
       plot = methyl_volcano, width = 8, height = 6)
```

```{r}
plot_methylation_box_by_grade <- function(
  gene_symbol,
  betas_mat = betas_g13,
  clin_df  = methyl_clinical_g13
) {
  
  # CpGs annotated to this gene
  gene_mask <- !is.na(cpg_sites[[gene_col]]) &
    grepl(paste0("\\b", gene_symbol, "\\b"), cpg_sites[[gene_col]])
  
  if(!any(gene_mask)) {
    message("No CpG sites found for gene: ", gene_symbol)
    return(NULL)
  }
  
  # subset betas
  betas_gene <- betas_mat[gene_mask, , drop = FALSE]
  mean_beta  <- colMeans(betas_gene, na.rm = TRUE)
  
  df <- data.frame(
    mean_beta   = mean_beta,
    tumor_grade = clin_df$tumor_grade
  )
  
  # significant test
  kw <- kruskal.test(mean_beta ~ tumor_grade, data = df)
  pval <- kw$p.value
  
  # Short formatted p-value
  ptxt <- ifelse(pval < 0.001, "p < 0.001", paste0("p = ", signif(pval, 3)))
  
  cat("\n===== ", gene_symbol, " Methylation Comparison by Grade =====\n")
  print(kw)
  cat("Formatted p-value:", ptxt, "\n\n")
  
  # ---- Plot ----
  p <- ggplot(df, aes(x = tumor_grade, y = mean_beta, fill = tumor_grade)) +
    geom_boxplot(alpha = 0.8) +
    theme_bw() +
    labs(
      title = paste0(
        "Mean DNA Methylation in ", gene_symbol,
        " by Tumor Grade\n", "Kruskalâ€“Wallis: ", ptxt
      ),
      x = "Tumor Grade",
      y = "Mean Beta Value"
    ) +
    theme(legend.position = "none")
  
  print(p)
  
  # save
  ggsave(
    filename = paste0("methylation_boxplot_", gene_symbol, "_by_grade.png"),
    plot = p, width = 6, height = 4
  )
  
  return(invisible(list(
    df = df,
    test = kw,
    pval = pval
  )))
}

# Example:
plot_methylation_box_by_grade("CCND2")

```


