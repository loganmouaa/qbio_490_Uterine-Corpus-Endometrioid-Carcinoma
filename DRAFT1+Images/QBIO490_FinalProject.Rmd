---
title: "UCEC Multi-Omic Analysis - Selina"
date: "Fall 2025"
output: html_notebook
---

```{r setup}
# Set up outputs directory as required by project guidelines
output_dir <- "/home1/selinali/490_cluster/analysis_data/outputs"
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}
knitr::opts_knit$set(root.dir = output_dir)
```

```{r}
# Load all required packages
if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install(version = "3.21")

if (!require("TCGAbiolinks", quietly = TRUE))
  BiocManager::install("TCGAbiolinks")
if (!require("maftools", quietly = TRUE))
  BiocManager::install("maftools")
if (!require("DESeq2", quietly = TRUE))
  BiocManager::install("DESeq2")
if (!require("survival", quietly = TRUE))
  install.packages("survival")
if (!require("survminer", quietly = TRUE))
  install.packages("survminer")
if (!require("ggplot2", quietly = TRUE))
  install.packages("ggplot2")
if (!require("EnhancedVolcano", quietly = TRUE))
  BiocManager::install("EnhancedVolcano")
if (!require("limma", quietly = TRUE))
  BiocManager::install("limma")
if (!require("sesame", quietly = TRUE))
  BiocManager::install("sesame")
if (!require("data.table", quietly = TRUE))
  install.packages("data.table")

library(TCGAbiolinks)
library(maftools)
library(DESeq2)
library(survival)
library(survminer)
library(ggplot2)
library(EnhancedVolcano)
library(limma)
library(sesame)
library(data.table)
```

#1. Clinical Data Analysis
```{r}
#Query and download clinical data for UCEC
clin_query <- GDCquery(project = "TCGA-UCEC",
                       data.category = "Clinical",
                       data.type = "Clinical Supplement", 
                       data.format = 'BCR Biotab')

GDCdownload(clin_query)
clinical_data <- GDCprepare(clin_query)
clinic <- clinical_data$clinical_patient_ucec[-c(1,2),]

# Fix column names
colnames(clinic)[colnames(clinic) == "bcr_patient_barcode"] <- "Tumor_Sample_Barcode"

# Prepare survival data
clinic$survival_time <- ifelse(clinic$last_contact_days_to == "[Not Available]" | 
                               is.na(clinic$last_contact_days_to),
                               clinic$death_days_to,
                               clinic$last_contact_days_to)

clinic$survival_time <- as.numeric(clinic$survival_time)
clinic$death_event <- ifelse(clinic$vital_status == "Dead", TRUE, FALSE)

#Filter for relevant tumor grades
clinic_clean <- clinic[!is.na(clinic$survival_time) & !is.na(clinic$death_event), ]
clinic_clean <- clinic_clean[clinic_clean$neoplasm_histologic_grade %in% c("G1", "G2", "G3"), ]

print(paste("Final clinical dataset:", nrow(clinic_clean), "patients"))
```
```{r}
# Survival analysis by tumor grade
survival_object <- Surv(time = clinic_clean$survival_time, 
                       event = clinic_clean$death_event)

fit_grade <- survfit(survival_object ~ neoplasm_histologic_grade, 
                    data = clinic_clean)

grade_surv_plot <- ggsurvplot(fit_grade,
                             pval = TRUE,
                             risk.table = TRUE,
                             conf.int = FALSE,
                             ggtheme = theme_bw(),
                             title = "UCEC Survival by Tumor Grade",
                             xlab = "Time (days)",
                             ylab = "Survival Probability")

print(grade_surv_plot)
ggsave("clinical_survival_by_grade.png", plot = grade_surv_plot$plot)

# Tumor grade distribution
grade_counts <- table(clinic_clean$neoplasm_histologic_grade)
grade_df <- data.frame(Grade = names(grade_counts), 
                      Count = as.numeric(grade_counts))

grade_dist_plot <- ggplot(grade_df, aes(x = Grade, y = Count, fill = Grade)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = Count), vjust = -0.5) +
  labs(title = "Tumor Grade Distribution in UCEC",
       x = "Tumor Grade", y = "Number of Patients") +
  theme_minimal() +
  theme(legend.position = "none")

print(grade_dist_plot)
ggsave("clinical_grade_distribution.png", plot = grade_dist_plot)
```

#2. GENOMIC DATA - MAF
```{r}
#Query and download mafmutation data
maf_query <- GDCquery(project = "TCGA-UCEC",
                      data.category = "Simple Nucleotide Variation",
                      data.type = "Masked Somatic Mutation", 
                      workflow.type = "Aliquot Ensemble Somatic Variant Merging and Masking",
                      access = "open")

GDCdownload(maf_query)
maf_data <- GDCprepare(maf_query)

# Prepare clinical data for MAF
clinic_maf <- clinic_clean
maf_object <- read.maf(maf = maf_data, clinicalData = clinic_maf, verbose = TRUE)

print(maf_object)
```
```{r}
# Oncoplot - top 20 mutated genes
png("genomic_oncoplot.png", width = 12, height = 8, units = "in", res = 300)
oncoplot(maf = maf_object, top = 20, fontSize = 0.8)
dev.off()

# Lollipop plots for key UCEC genes

#PTEN
pten_maf <- subsetMaf(maf = maf_object, genes = "PTEN", mafObj = TRUE)

png("genomic_PTEN_lollipop.png", width = 8, height = 6, units = "in", res = 300)
lollipopPlot(maf = pten_maf, gene = "PTEN", AACol = "HGVSp_Short",
             showMutationRate = FALSE, cBioPortal = FALSE)
title("PTEN Mutations in UCEC", cex.main = 1.2)
dev.off()

#TP53
tp53_maf <- subsetMaf(maf = maf_object, genes = "TP53", mafObj = TRUE)

png("genomic_TP53_lollipop.png", width = 8, height = 6, units = "in", res = 300)
lollipopPlot(maf = tp53_maf, gene = "TP53",
             AACol = "HGVSp_Short",
             showMutationRate = FALSE, cBioPortal = FALSE)
title("TP53 Mutations in UCEC", cex.main = 1.2)
dev.off()

#CCNd
ccnd2_maf <- subsetMaf(maf = maf_object, genes = "CCND2", mafObj = TRUE)

png("genomic_CCND2_lollipop.png", width = 8, height = 6, units = "in", res = 300)
lollipopPlot(maf = ccnd2_maf, gene = "CCND2",
             AACol = "HGVSp_Short",
             showMutationRate = FALSE, cBioPortal = FALSE)
title("CCND2 Mutations in UCEC", cex.main = 1.2)
dev.off()

#Summary
png("genomic_mutation_summary.png", width = 10, height = 8, units = "in", res = 300)
plotmafSummary(maf = maf_object, rmOutlier = TRUE, addStat = 'median')
dev.off()
```

#3. TRANSCRIPTOMIC DATA (RNA-seq)
```{r}
#Query and download RNA-seq data
rna_query <- GDCquery(project = "TCGA-UCEC",
                      data.category = "Transcriptome Profiling",
                      data.type = "Gene Expression Quantification", 
                      workflow.type = "STAR - Counts")

GDCdownload(rna_query)

```

```{r}
# Prepare SummarizedExperiment
rna_se <- GDCprepare(rna_query)

rna_counts   <- assay(rna_se, "unstranded")
rna_clinical <- as.data.frame(colData(rna_se))

#use 12-char PATIENT IDs

fix_patient12 <- function(x) {
  x2 <- gsub("\\.", "-", x)
  substr(x2, 1, 12)
}

# Patient IDs from RNA columns
rna_patient <- fix_patient12(colnames(rna_counts))

# Patient IDs from clinical table
clinic_clean$patient_short <- fix_patient12(clinic_clean$Tumor_Sample_Barcode)

# Keep only samples with non-missing grade
clinic_grade       <- clinic_clean[!is.na(clinic_clean$neoplasm_histologic_grade), ]
clinic_grade_short <- clinic_grade$patient_short

# Overlap between RNA and clinical
common_patients <- intersect(rna_patient, clinic_grade_short)

cat("Total RNA samples:", length(rna_patient), "\n")
cat("Clinical w/ grade samples", length(clinic_grade_short), "\n")
cat("Common patient IDs:", length(common_patients), "\n")

# Continue from your code - now prepare for DESeq2 analysis
```




```{r}

# Get the indices of the RNA samples that match our common patients
rna_indices <- which(rna_patient %in% common_patients)

# Subset the RNA counts and clinical data to only common patients
rna_counts_common <- rna_counts[, rna_indices]
rna_clinical_common <- rna_clinical[rna_indices, ]

# Create a mapping between RNA sample IDs and patient clinical data
patient_to_grade <- setNames(clinic_grade$neoplasm_histologic_grade, 
                            clinic_grade$patient_short)

# Add tumor grade to RNA clinical data
rna_clinical_common$tumor_grade <- patient_to_grade[rna_patient[rna_indices]]

print(paste("Final RNA-seq dataset:", ncol(rna_counts_common), "samples,", nrow(rna_counts_common), "genes"))
print("Tumor grade distribution in RNA-seq data:")
print(table(rna_clinical_common$tumor_grade))

```
```{r}
# Prepare for DESeq2 analysis
# Convert counts to matrix and ensure numeric values
count_matrix <- as.matrix(rna_counts_common)
mode(count_matrix) <- "numeric"

# Remove any NA values
count_matrix[is.na(count_matrix)] <- 0

# Filter low-count genes (following class examples)
keep_genes <- rowSums(count_matrix) >= 10
count_matrix_filtered <- count_matrix[keep_genes, ]

print(paste("After filtering:", nrow(count_matrix_filtered), "genes remaining"))

# Ensure tumor_grade is a factor with proper levels
rna_clinical_common$tumor_grade <- factor(rna_clinical_common$tumor_grade, 
                                         levels = c("G1", "G2", "G3"))

# Create DESeq2 dataset
dds <- DESeqDataSetFromMatrix(
  countData = count_matrix_filtered,
  colData = rna_clinical_common,
  design = ~ tumor_grade
)

print("DESeq2 dataset created successfully!")
print(dds)
```

```{r}
# DESeq2

dds <- DESeq(dds)
# Get results for different comparisons
# G3 vs G1
results_g3_vs_g1 <- results(dds, contrast = c("tumor_grade", "G3", "G1"))
results_g3_vs_g1_df <- as.data.frame(results_g3_vs_g1)

# G2 vs G1  
results_g2_vs_g1 <- results(dds, contrast = c("tumor_grade", "G2", "G1"))
results_g2_vs_g1_df <- as.data.frame(results_g2_vs_g1)

print("DESeq2 analysis completed!")
print(paste("G3 vs G1 - significant genes (padj < 0.05):", 
            sum(results_g3_vs_g1_df$padj < 0.05, na.rm = TRUE)))
print(paste("G2 vs G1 - significant genes (padj < 0.05):", 
            sum(results_g2_vs_g1_df$padj < 0.05, na.rm = TRUE)))
```

```{r}
# Get results for different comparisons
# G3 vs G1
results_g3_vs_g1 <- results(dds, contrast = c("tumor_grade", "G3", "G1"))
results_g3_vs_g1_df <- as.data.frame(results_g3_vs_g1)

# G2 vs G1  
results_g2_vs_g1 <- results(dds, contrast = c("tumor_grade", "G2", "G1"))
results_g2_vs_g1_df <- as.data.frame(results_g2_vs_g1)

print("DESeq2 analysis completed!")
print(paste("G3 vs G1 - significant genes (padj < 0.05):", 
            sum(results_g3_vs_g1_df$padj < 0.05, na.rm = TRUE)))
print(paste("G2 vs G1 - significant genes (padj < 0.05):", 
            sum(results_g2_vs_g1_df$padj < 0.05, na.rm = TRUE)))
```
```{r}
# Add gene names to results
# First, let's get the gene information from the rowData of rna_se
rna_genes <- as.data.frame(rowData(rna_se))

# Add gene names to our results dataframes
results_g3_vs_g1_df$gene_name <- rna_genes$gene_name[match(rownames(results_g3_vs_g1_df), rna_genes$gene_id)]
results_g2_vs_g1_df$gene_name <- rna_genes$gene_name[match(rownames(results_g2_vs_g1_df), rna_genes$gene_id)]

# Create volcano plots for both comparisons
volcano_g3_vs_g1 <- EnhancedVolcano(results_g3_vs_g1_df,
                lab = results_g3_vs_g1_df$gene_name,
                x = 'log2FoldChange',
                y = 'pvalue',
                title = 'Differential Expression: G3 vs G1 Tumors',
                subtitle = 'UCEC Transcriptomic Analysis',
                pCutoff = 0.05,
                FCcutoff = 1.0,
                pointSize = 2.0,
                labSize = 4.0)

volcano_g2_vs_g1 <- EnhancedVolcano(results_g2_vs_g1_df,
                lab = results_g2_vs_g1_df$gene_name,
                x = 'log2FoldChange',
                y = 'pvalue',
                title = 'Differential Expression: G2 vs G1 Tumors',
                subtitle = 'UCEC Transcriptomic Analysis',
                pCutoff = 0.05,
                FCcutoff = 1.0,
                pointSize = 2.0,
                labSize = 4.0)

print(volcano_g3_vs_g1)
ggsave("transcriptomic_volcano_G3_vs_G1.png", plot = volcano_g3_vs_g1, width = 10, height = 8)

print(volcano_g2_vs_g1)
ggsave("transcriptomic_volcano_G2_vs_G1.png", plot = volcano_g2_vs_g1, width = 10, height = 8)
```

```{r}

# Query and download methylation data
methyl_query <- GDCquery(
  project      = "TCGA-UCEC",
  data.category = "DNA Methylation",
  data.type     = "Methylation Beta Value",
  platform      = "Illumina Human Methylation 450"
)


GDCdownload(methyl_query)

```
```{r}
methyl_se <- GDCprepare(methyl_query)

# Extract beta values and clinical data
methyl_betas <- assay(methyl_se)
methyl_clinical <- as.data.frame(colData(methyl_se))

print(paste("Methylation data dimensions:", dim(methyl_betas)[1], "probes x", dim(methyl_betas)[2], "samples"))

# Save methylation data for analysis
write.csv(methyl_betas, "ucec_methylation_betas.csv")
write.csv(methyl_clinical, "ucec_methylation_clinical.csv")

# Create CpG site information
cpg_genes <- data.frame(
  gene = rowData(methyl_se)$gene_name,
  row.names = rownames(methyl_betas)
)
write.csv(cpg_genes, "ucec_cpg_sites.csv")
```


